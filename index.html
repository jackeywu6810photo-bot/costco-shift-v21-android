<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="color-scheme" content="light">
  <title>Costco ç­è¡¨ç®¡ç† V2.1</title>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <!-- Capacitor -->
  <script src="capacitor.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: #f5f5f5;
      color: #333;
      min-height: 100vh;
    }
    
    .app-container {
      max-width: 100%;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    /* æ¨™é¡Œåˆ— */
    .header {
      background: linear-gradient(135deg, #E31837 0%, #C41230 100%);
      color: white;
      padding: 16px;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    
    .header h1 {
      font-size: 20px;
      font-weight: 600;
    }
    
    /* å·¥å…·åˆ— */
    .toolbar {
      display: flex;
      gap: 8px;
      padding: 12px;
      background: white;
      border-bottom: 1px solid #e0e0e0;
      overflow-x: auto;
      flex-wrap: nowrap;
    }
    
    .toolbar button {
      padding: 10px 16px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
      transition: transform 0.1s;
    }
    
    .toolbar button:active {
      transform: scale(0.95);
    }
    
    .btn-shift { background: #FFD54F; color: #E31837; }
    .btn-chart { background: #4CAF50; color: white; }
    .btn-ai { background: #9C27B0; color: white; }
    .btn-sync { background: #FF9800; color: white; }
    .btn-settings { background: #607D8B; color: white; }
    
    /* ä¸»è¦å…§å®¹å€ */
    .main-content {
      flex: 1;
      padding: 12px;
      overflow-y: auto;
    }
    
    /* æ—¥æ›†æ¨£å¼ */
    .calendar {
      background: white;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .calendar-header button {
      background: #E31837;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 14px;
    }
    
    .calendar-header h2 {
      font-size: 18px;
      color: #333;
    }
    
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
    }
    
    .weekday {
      text-align: center;
      font-size: 12px;
      color: #666;
      padding: 8px 0;
      font-weight: 600;
    }
    
    .day-cell {
      aspect-ratio: 1;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 4px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      min-height: 60px;
    }
    
    .day-cell:active {
      transform: scale(0.95);
    }
    
    .day-cell.today {
      border: 2px solid #E31837;
    }
    
    .day-cell.holiday {
      background: #FFEBEE;
    }
    
    .day-cell.selected {
      background: #E3F2FD;
      border-color: #2196F3;
    }
    
    .day-number {
      font-size: 14px;
      font-weight: 600;
      color: #333;
    }
    
    .day-shift {
      font-size: 10px;
      color: #E31837;
      font-weight: 600;
      margin-top: 2px;
    }
    
    .day-hours {
      font-size: 9px;
      color: #666;
    }
    
    /* ç‹€æ…‹åˆ— */
    .status-bar {
      background: white;
      padding: 12px;
      border-top: 1px solid #e0e0e0;
      display: flex;
      justify-content: space-around;
      font-size: 12px;
    }
    
    .status-item {
      text-align: center;
    }
    
    .status-value {
      font-size: 16px;
      font-weight: 700;
      color: #E31837;
    }
    
    .status-label {
      color: #666;
      margin-top: 2px;
    }
    
    /* å½ˆçª— */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    
    .modal.active {
      display: flex;
    }
    
    .modal-content {
      background: white;
      border-radius: 16px;
      padding: 24px;
      max-width: 400px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .modal-header h3 {
      font-size: 18px;
      color: #333;
    }
    
    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #666;
    }
    
    .form-group {
      margin-bottom: 16px;
    }
    
    .form-group label {
      display: block;
      font-size: 14px;
      color: #666;
      margin-bottom: 6px;
    }
    
    .form-group input,
    .form-group select {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
    }
    
    .btn-primary {
      background: #E31837;
      color: white;
      border: none;
      padding: 14px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      width: 100%;
      cursor: pointer;
    }
    
    .btn-primary:active {
      background: #C41230;
    }
    
    /* åœ–è¡¨å®¹å™¨ */
    .chart-container {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
    }
    
    /* è¼‰å…¥å‹•ç•« */
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 200px;
    }
    
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #e0e0e0;
      border-top-color: #E31837;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- æ¨™é¡Œ -->
    <div class="header">
      <h1>ğŸ—“ï¸ Costco ç­è¡¨ç®¡ç† V2.1</h1>
    </div>
    
    <!-- å·¥å…·åˆ— -->
    <div class="toolbar">
      <button class="btn-shift" onclick="selectShiftType('A')">æ—©ç­</button>
      <button class="btn-shift" onclick="selectShiftType('B')">æ™šç­</button>
      <button class="btn-shift" onclick="selectShiftType('C')">ä¼‘å‡</button>
      <button class="btn-chart" onclick="showCharts()">ğŸ“Š åœ–è¡¨</button>
      <button class="btn-ai" onclick="showAI()">ğŸ¤– AI</button>
      <button class="btn-sync" onclick="showSync()">â˜ï¸ åŒæ­¥</button>
      <button class="btn-settings" onclick="showSettings()">âš™ï¸ è¨­å®š</button>
    </div>
    
    <!-- ä¸»è¦å…§å®¹ -->
    <div class="main-content">
      <div class="calendar">
        <div class="calendar-header">
          <button onclick="changeMonth(-1)">< ä¸Šå€‹æœˆ</button>
          <h2 id="currentMonth">2026å¹´ 3æœˆ</h2>
          <button onclick="changeMonth(1)">ä¸‹å€‹æœˆ ></button>
        </div>
        
        <div class="calendar-grid" id="calendarGrid">
          <!-- æ˜ŸæœŸæ¨™é¡Œ -->
          <div class="weekday">æ—¥</div>
          <div class="weekday">ä¸€</div>
          <div class="weekday">äºŒ</div>
          <div class="weekday">ä¸‰</div>
          <div class="weekday">å››</div>
          <div class="weekday">äº”</div>
          <div class="weekday">å…­</div>
          <!-- æ—¥æœŸç”± JavaScript ç”Ÿæˆ -->
        </div>
      </div>
    </div>
    
    <!-- ç‹€æ…‹åˆ— -->
    <div class="status-bar">
      <div class="status-item">
        <div class="status-value" id="totalHours">0h</div>
        <div class="status-label">æœ¬æœˆå·¥æ™‚</div>
      </div>
      <div class="status-item">
        <div class="status-value" id="totalPay">$0</div>
        <div class="status-label">é ä¼°è–ªè³‡</div>
      </div>
      <div class="status-item">
        <div class="status-value" id="currentLevel">1</div>
        <div class="status-label">ç•¶å‰è·ç´š</div>
      </div>
    </div>
  </div>
  
  <!-- è¨­å®šç­æ¬¡å½ˆçª— -->
  <div class="modal" id="shiftModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>è¨­å®šç­è¡¨</h3>
        <button class="modal-close" onclick="closeModal('shiftModal')">Ã—</button>
      </div>
      
      <div class="form-group">
        <label>æ—¥æœŸ</label>
        <input type="date" id="shiftDate" readonly>
      </div>
      
      <div class="form-group">
        <label>ç­æ¬¡é¡å‹</label>
        <select id="shiftType">
          <option value="A">æ—©ç­ (09:00-17:30)</option>
          <option value="B">æ™šç­ (14:30-23:00)</option>
          <option value="C">ä¼‘å‡</option>
          <option value="L">å¹´ä¼‘/å½ˆä¼‘</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>å·¥ä½œæ™‚æ•¸</label>
        <input type="number" id="shiftHours" value="8" min="0" max="12" step="0.5">
      </div>
      
      <div class="form-group">
        <label>åŠ ç­æ™‚æ•¸</label>
        <input type="number" id="shiftOvertime" value="0" min="0" max="8" step="0.5">
      </div>
      
      <button class="btn-primary" onclick="saveShift()">ğŸ’¾ å„²å­˜ç­è¡¨</button>
    </div>
  </div>
  
  <!-- è¼‰å…¥ä¸­ -->
  <div id="loading" style="display:none;">
    <div class="loading">
      <div class="spinner"></div>
    </div>
  </div>

  <!-- å¼•å…¥æ ¸å¿ƒæ¨¡çµ„ -->
  <script src="src/core/calculator.js"></script>
  <script src="src/core/database.js"></script>
  <script src="src/core/ai_scheduler.js"></script>
  <script src="src/core/firebase_sync.js"></script>
  
  <script>
    // å…¨å±€è®Šæ•¸
    let db;
    let aiScheduler;
    let firebaseSync;
    let currentDate = new Date();
    let selectedDate = null;
    let currentShiftType = null;
    let shifts = {};
    
    // ç­æ¬¡å®šç¾©
    const shiftTypes = {
      'A': { name: 'æ—©ç­', hours: 8, desc: '09:00-17:30' },
      'B': { name: 'æ™šç­', hours: 8, desc: '14:30-23:00' },
      'C': { name: 'ä¼‘å‡', hours: 0, desc: '-' },
      'L': { name: 'å¹´/å½ˆä¼‘', hours: 8, desc: '8H' }
    };
    
    // åˆå§‹åŒ–
    async function init() {
      console.log('ğŸš€ åˆå§‹åŒ– App...');
      
      // åˆå§‹åŒ–è³‡æ–™åº«
      db = new ShiftDatabase();
      await db.init();
      console.log('âœ… è³‡æ–™åº«åˆå§‹åŒ–å®Œæˆ');
      
      // åˆå§‹åŒ– AI
      aiScheduler = new AIScheduler(db);
      console.log('âœ… AI åˆå§‹åŒ–å®Œæˆ');
      
      // åˆå§‹åŒ– Firebase
      firebaseSync = new FirebaseSync();
      await firebaseSync.init();
      console.log('âœ… Firebase åˆå§‹åŒ–å®Œæˆ');
      
      // è¼‰å…¥ç­è¡¨è³‡æ–™
      await loadShifts();
      
      // æ¸²æŸ“æ—¥æ›†
      renderCalendar();
      
      // æ›´æ–°ç‹€æ…‹
      updateStatus();
      
      console.log('ğŸ‰ App åˆå§‹åŒ–å®Œæˆï¼');
    }
    
    // è¼‰å…¥ç­è¡¨
    async function loadShifts() {
      shifts = await db.getAllShifts();
      console.log('ğŸ“Š è¼‰å…¥ç­è¡¨:', Object.keys(shifts).length, 'ç­†');
    }
    
    // æ¸²æŸ“æ—¥æ›†
    function renderCalendar() {
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth() + 1;
      
      document.getElementById('currentMonth').textContent = `${year}å¹´ ${month}æœˆ`;
      
      const grid = document.getElementById('calendarGrid');
      // ä¿ç•™æ˜ŸæœŸæ¨™é¡Œ
      const weekdayHeaders = grid.querySelectorAll('.weekday');
      grid.innerHTML = '';
      weekdayHeaders.forEach(h => grid.appendChild(h));
      
      // è¨ˆç®—æ—¥æœŸ
      const firstDay = new Date(year, month - 1, 1);
      const lastDay = new Date(year, month, 0);
      const startPadding = firstDay.getDay();
      
      // å¡«å…¥ç©ºç™½
      for (let i = 0; i < startPadding; i++) {
        const cell = document.createElement('div');
        grid.appendChild(cell);
      }
      
      // å¡«å…¥æ—¥æœŸ
      const today = new Date();
      for (let day = 1; day <= lastDay.getDate(); day++) {
        const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const shift = shifts[dateStr];
        
        const cell = document.createElement('div');
        cell.className = 'day-cell';
        
        if (year === today.getFullYear() && 
            month === today.getMonth() + 1 && 
            day === today.getDate()) {
          cell.classList.add('today');
        }
        
        if (shift) {
          const shiftInfo = shiftTypes[shift.type] || { name: shift.name, hours: shift.hours };
          cell.innerHTML = `
            <div class="day-number">${day}</div>
            <div class="day-shift">${shiftInfo.name}</div>
            <div class="day-hours">${shift.hours}h</div>
          `;
        } else {
          cell.innerHTML = `<div class="day-number">${day}</div>`;
        }
        
        cell.onclick = () => openShiftModal(dateStr);
        grid.appendChild(cell);
      }
    }
    
    // åˆ‡æ›æœˆä»½
    function changeMonth(delta) {
      currentDate.setMonth(currentDate.getMonth() + delta);
      renderCalendar();
      updateStatus();
    }
    
    // é¸æ“‡ç­æ¬¡é¡å‹
    function selectShiftType(type) {
      currentShiftType = type;
      console.log('ğŸ“ é¸æ“‡ç­æ¬¡é¡å‹:', type);
      // å¯ä»¥æ·»åŠ è¦–è¦ºåé¥‹
    }
    
    // é–‹å•Ÿç­æ¬¡è¨­å®šå½ˆçª—
    function openShiftModal(dateStr) {
      selectedDate = dateStr;
      document.getElementById('shiftDate').value = dateStr;
      
      // è¼‰å…¥ç¾æœ‰è³‡æ–™
      const shift = shifts[dateStr];
      if (shift) {
        document.getElementById('shiftType').value = shift.type || 'A';
        document.getElementById('shiftHours').value = shift.hours || 8;
        document.getElementById('shiftOvertime').value = shift.overtime || 0;
      } else {
        document.getElementById('shiftType').value = currentShiftType || 'A';
        document.getElementById('shiftHours').value = 8;
        document.getElementById('shiftOvertime').value = 0;
      }
      
      document.getElementById('shiftModal').classList.add('active');
    }
    
    // å„²å­˜ç­è¡¨
    async function saveShift() {
      const type = document.getElementById('shiftType').value;
      const hours = parseFloat(document.getElementById('shiftHours').value) || 0;
      const overtime = parseFloat(document.getElementById('shiftOvertime').value) || 0;
      
      const shiftInfo = shiftTypes[type] || { name: 'è‡ªè¨‚', desc: '' };
      
      const shiftData = {
        type,
        name: shiftInfo.name,
        hours,
        overtime,
        desc: shiftInfo.desc
      };
      
      await db.saveShift(selectedDate, shiftData);
      shifts[selectedDate] = shiftData;
      
      closeModal('shiftModal');
      renderCalendar();
      updateStatus();
      
      console.log('âœ… ç­è¡¨å·²å„²å­˜:', selectedDate, shiftData);
    }
    
    // é—œé–‰å½ˆçª—
    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
    }
    
    // æ›´æ–°ç‹€æ…‹åˆ—
    function updateStatus() {
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth() + 1;
      
      let monthHours = 0;
      let monthPay = 0;
      
      Object.keys(shifts).forEach(dateStr => {
        if (dateStr.startsWith(`${year}-${String(month).padStart(2, '0')}`)) {
          const shift = shifts[dateStr];
          monthHours += shift.hours || 0;
          
          // è¨ˆç®—è–ªè³‡
          if (shift.hours > 0) {
            const base = Math.min(shift.hours, 8) * 358 * 1.667;
            const ot = (shift.overtime || 0) * 358 * 2.667;
            monthPay += base + ot;
          }
        }
      });
      
      document.getElementById('totalHours').textContent = monthHours.toFixed(1) + 'h';
      document.getElementById('totalPay').textContent = '$' + Math.round(monthPay).toLocaleString();
      
      // å–å¾—è·ç´š
      const config = { current_step: 1 }; // ç°¡åŒ–ï¼Œå¯¦éš›æ‡‰å¾è³‡æ–™åº«è®€å–
      const totalHours = Object.values(shifts).reduce((sum, s) => sum + (s.hours || 0), 0);
      const levelInfo = getLevelInfo(totalHours, config.current_step);
      document.getElementById('currentLevel').textContent = levelInfo.currentLevel;
    }
    
    // é¡¯ç¤ºåœ–è¡¨
    function showCharts() {
      alert('ğŸ“Š åœ–è¡¨åŠŸèƒ½é–‹ç™¼ä¸­...');
    }
    
    // é¡¯ç¤º AI å»ºè­°
    function showAI() {
      const analysis = aiScheduler.getFullAnalysis(shifts);
      const suggestion = analysis.suggestions[0];
      alert(`${suggestion.icon} ${suggestion.title}\n\n${suggestion.message}`);
    }
    
    // é¡¯ç¤ºåŒæ­¥
    function showSync() {
      alert('â˜ï¸ åŒæ­¥åŠŸèƒ½é–‹ç™¼ä¸­...');
    }
    
    // é¡¯ç¤ºè¨­å®š
    function showSettings() {
      alert('âš™ï¸ è¨­å®šåŠŸèƒ½é–‹ç™¼ä¸­...');
    }
    
    // å•Ÿå‹• App
    init().catch(err => {
      console.error('âŒ åˆå§‹åŒ–å¤±æ•—:', err);
      alert('App åˆå§‹åŒ–å¤±æ•—: ' + err.message);
    });
  </script>
</body>
</html>
